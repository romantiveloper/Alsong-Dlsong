{% extends 'navbar.html' %}
{% block style %}


<!-- jquery ì‚¬ìš©í•˜ê¸° ìœ„í•´ -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://kit.fontawesome.com/95c5c08857.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/static/css/main-html.css">

<style></style>
{% endblock %}


{% block content %}
<div class="home">
    <div class="main">
        <div class="logo-box">
            <div class="logo-text">
                <img style="width: 160%; height: 150%" src="/static/img/ì•Œì†¡ë‹¬ì†¡-ë¡œê³ -final_ì—¬ë°±ì œê±°.png" />
            </div>
        </div>

        <div class="main-box">
            <a href="/song-list/search/" style="width: 80%;">
                <div class="searchbar">
                    <div class="search-img">
                        <img src="/static/img/icon-search-normal-1.svg">
                    </div>
                    <div class="search-text">
                        ë¶€ë¥´ê³  ì‹¶ì€ ê³¡ì„ ê²€ìƒ‰í•˜ì„¸ìš”!
                    </div>
                </div>
            </a>
            
            {% if request.user.is_authenticated %}
            <div class="main-banner">
                <div class="dashboard"></div>
                <div class="banner-profile">

                    <div class="profile-img-box">
                        <div class="profile-img">
                            <div class="Dicons">
                                <img style="width: 56px; height: 72px" src="/static/img/music.svg" />
                            </div>
                        </div>
                    </div>
                    {% for users in user %}
                    <div class="frame-25">
                        <div class="frame-25-text-1">{{users.nickname}}</div>
                        <div class="frame-25-text-2">ë‹˜ ì•ˆë…•í•˜ì„¸ìš” ğŸ¶</div>
                    </div>
                    {% endfor %}
                    <div class="frame-1992">
                        <div class="group-25">
                            <div class="frame-1992-text-1">ì´ ë‹¬ë¦° ê³¡</div>
                            {% with total_song_count=0 %}
                                {% for list in folder_list %}
                                    {% with new_total_song_count=total_song_count|add:list.song_count %}
                                        {% with total_song_count=new_total_song_count %}
                                        {% endwith %}
                                    {% endwith %}
                                {% endfor %}
                                <div class="frame-1992-text-2">{{ total_song_count }}</div>
                            {% endwith %}
                            <div class="frame-1992-text-3">ê³¡</div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="main-banner">
                <div class="dashboard"></div>
                <div class="banner-profile">

                    <div class="profile-img-box">
                        <div class="profile-img">
                            <div class="Dicons">
                                <img style="width: 56px; height: 72px" src="/static/img/music.svg" />
                            </div>
                        </div>
                    </div>
                    <div class="frame-25">
                        <div class="frame-25-text-1">ì•„ì§ ë¡œê·¸ì¸ì„ ì•ˆí•˜ì…¨ë‚˜ìš”??</div>
                    </div>
                    <div class="frame-1992">
                        <div class="group-25">
                            <div class="frame-1992-text-1" style="width: 180px;">
                                <a href="/user/sign-in/">ë¡œê·¸ì¸ í•˜ëŸ¬ ê°€ê¸° >>></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% endif %}

            
            <div class="recommend-banner">
                <a href="/recommend/">
                    <div class="recommend-title">
                        <div class="ai">Ai ë¶€ë¥¼ê³¡ ì¶”ì²œ ë°›ê¸°!</div>
                        <img class="frame-4" src="/static/img/vector.svg">
                    </div>
                </a>
            </div>

            <div class="folder-box">
                <div class="folder-box-design"></div>
                <div class="folder-box-title">
                    <div class="folder-box-title-text">ë‹¬ì†¡ í´ë”</div>
                </div>

                <div class="folder-box" style="margin-top: 50px; margin-bottom: 20px; justify-content: space-around; flex-direction: row; flex-wrap: wrap; width: calc(2*168px + 2*1vw);">
                    {% for list in folder_list %}
                    <div class="folder list_button" data-list-number="{{ list.list_number }}">
                        <div style="height: 80px;">
                            <div class="folder-name-1">{{list.list_name}}</div>
                            <div class="folder-in-song">{{list.song_count}} ê³¡</div>
                        </div>
                        <div class="img-box">
                            <div class="ellipse-11">
                                <div class="_3-dicons">
                                    <img class="_3-dicons2" src="/static/img/mic-dicons.svg" />
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    <div class="folder" id="button_add_list">
                        <div style="height: 80px;">
                            <div class="folder-name-2">ìƒˆ í´ë” ì¶”ê°€</div>
                            <div class="folder-in-song"></div>
                        </div>
                        <div class="img-box">
                            <div class="ellipse-11">
                                <div class="_3-dicons">
                                    <img class="_3-dicons2" src="/static/img/add-dicons.png" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- ëª¨ë‹¬ content ë¶€ë¶„-->
<div id="modal_add_feed_content" class="modal modal_overlay_content">
    <div class="modal_window">
        <div class="modal_title">
            <div class="modal_title_side"></div>
            <div class="modal-title-center">í´ë” ìƒì„±</div>
            <div class="modal_title_side">
                <span id="close_modal" class="close_modal material-icons-outlined" style="font-size: 15px">
                    X
                </span>
            </div>
        </div>
        <div class="modal_content_write">
            <div class="feed_content_textarea">
                <input id="input_list_name" class="feed_content_textarea-box col-sm-5" rows="10" placeholder="7ê¸€ì ì´í•˜ í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"></input>
            </div>
        </div>
        <div class="modal-add-button-box">
            <button id="button_write_feed" type="button" class="modal-add-button btn btn-primary"> ì¶”ê°€í•˜ê¸°</button>
        </div>
    </div>
</div>


{% endblock %}

{% block script %}
<script>    
    $.ajaxSetup({
        headers: { "X-CSRFToken": '{{csrf_token}}' }
    });
</script>

<script>
    //ëª¨ë‹¬ ë„ìš°ê¸° ì½”ë“œ
    const modal = document.getElementById("modal_add_feed_content");
    const buttonAddFeed = document.getElementById("button_add_list");
    buttonAddFeed.addEventListener("click", e=> {
        modal.style.top = window.pageYOffset + 'px'; // topì„ ì´ìš©í•´ ì‹œì‘ y ìœ„ì¹˜ë¥¼ ë°”ê¿”ì¤Œ
        modal.style.display = "flex";
        document.body.style.overflowY = "hidden"; //ìŠ¤í¬ë¡¤ ì—†ì• ê¸°

        console.log(window.pageYOffset + " ìœ„ì¹˜"); //ë¡œê·¸ ì°ê¸°
    });

    //ëª¨ë‹¬ ë‹«ê¸° ì½”ë“œ
    const buttonCloseModal = 
    document.getElementById("close_modal");
    buttonCloseModal.addEventListener("click", e => {
        modal.style.display = "none";
        document.body.style.overflowY = "visible";
    });

    let listCount = 0; // ì¶”ê°€ëœ ë¦¬ìŠ¤íŠ¸ ê°œìˆ˜ë¥¼ ì¶”ì í•˜ê¸° ìœ„í•œ ë³€ìˆ˜

    

    function addList(fd) {
        $.ajax({
            url: 'add_list/', // ë°ì´í„°ë¥¼ ì „ì†¡í•  URL
            type: 'POST', // POST ë©”ì„œë“œ ì‚¬ìš©
            data: fd, // FormDataë¥¼ ì „ì†¡ ë°ì´í„°ë¡œ ì‚¬ìš©
            processData: false, // FormDataë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì§€ ì•ŠìŒ
            contentType: false, // ì»¨í…ì¸  ìœ í˜•ì„ ì„¤ì •í•˜ì§€ ì•ŠìŒ
            headers:{
                'X-CSRFToken':csrftoken
            },
            success: function(response) {
                // ì„±ê³µì ìœ¼ë¡œ ì‘ë‹µì„ ë°›ì•˜ì„ ë•Œ ì‹¤í–‰í•  ì½”ë“œ
                console.log(response);

                // ìƒˆë¡œìš´ ë¦¬ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•˜ëŠ” ì½”ë“œ
                const newList = `
                    <div style="background-color: aliceblue; width: 150px; margin: 10px; height: 150px; display: flex; justify-content: center; align-items: center;">
                        <span>${list_name}</span>
                    </div>
                `;

                $('#list_container').append(newList);
                listCount++;

                // ì¶”ê°€ ë²„íŠ¼ì„ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™í•˜ëŠ” ì½”ë“œ
                const buttonWidth = 170; // ì¶”ê°€ ë²„íŠ¼ì„ ê°ì‹¸ëŠ” <div> ìš”ì†Œì˜ ë„ˆë¹„ + ë§ˆì§„ê°’
                const containerWidth = 700; // ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆì˜ ë„ˆë¹„
                const maxButtonsPerRow = Math.floor(containerWidth / buttonWidth);

                if (listCount % maxButtonsPerRow === 0) {
                    $('#button_add_list').css('float', 'left');
                }

                //location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì¶”ê°€
            },
            error: function(xhr, errmsg, err) {
                // ìš”ì²­ì´ ì‹¤íŒ¨í–ˆì„ ë•Œ ì‹¤í–‰í•  ì½”ë“œ
                console.log(xhr.status + ": " + xhr.responseText);
                var errorMessage = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
                alert(errorMessage);
            }
        });
    }

    $('#button_write_feed').on('click', () => {
        const list_name = $('#input_list_name').val();

        if (list_name.length >= 7) {
                alert('í´ë” ì´ë¦„ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤. 7ê¸€ì ì´í•˜ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                return error;
            }

        let fd = new FormData();

        fd.append('list_name', list_name); 

        addList(fd); // ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ í•¨ìˆ˜ í˜¸ì¶œ

        // ì¶”ê°€ ë²„íŠ¼ í´ë¦­ í›„ ëª¨ë‹¬ ë‹«ê¸°
        modal.style.display = "none";
        document.body.style.overflowY = "visible";

        setTimeout(() => {
            location.reload();
        }, 100);
    });

    // ëª¨ë“  ë¦¬ìŠ¤íŠ¸ ë²„íŠ¼ì— ëŒ€í•´ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë“±ë¡
    const listButtons = document.querySelectorAll(".list_button");
    listButtons.forEach((listButton) => {
        listButton.addEventListener('click', () => {
            const listNumber = listButton.dataset.listNumber;
            const url = `/mylist/${listNumber}/`; // ì´ë™í•  URL ì„¤ì •
            window.location.href = url; // URLë¡œ ì´ë™
        });
    });

    
</script>
{% endblock %}