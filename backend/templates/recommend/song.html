{% extends 'navbar.html' %}
{% block style %}
<style>
    .main_body {
        display: flex;
        justify-content: center;
        padding-top: 5px;
        padding-left: 150px;
        background-color: #f7f7f7;
    }
</style>
<head>
</head>
<!DOCTYPE html>
<html>
<head>
    <title>ë…¸ë˜ ì°¨íŠ¸</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        select {
            width:70px;
            height:30px;
            padding:0 28px 0 10px;
            font-size: 16px;
            border:1px solid #d2d2d2;
            border-radius: 16px;
            -webkit-appearance:none; /* for chrome */
            -moz-appearance:none; /*for firefox*/
            appearance:none; 
            background:transparent; 
        }

        select::-ms-expand{
            display:none;/*for IE10,11*/
        }

        .select-wrap {
            width:70px;
            height: 30px;
            padding-left: 28px;
            /* border:1px solid #d2d2d2; */
            border-radius: 16px;
            background:url('/static/img/ìŠ¤í¬ë¦°ìƒ·\ 2023-07-19\ 031302.png') no-repeat 90% 50%/15px auto;
        }

        .form-container {
            display: flex;
            justify-content: center; /* ê°€ìš´ë° ì •ë ¬ */
        }

        .form-container div {
            margin-right: 10px; /* ê° ìš”ì†Œ ì‚¬ì´ì˜ ê°„ê²© ì¡°ì ˆ */
        }

        /* input íƒœê·¸ ìŠ¤íƒ€ì¼ë§ - ì´ë¯¸ì§€ ì¶”ê°€ */
        .input-wrap input {
            width: 300px;
            height: 30px;
            padding-left: 30px; /* ì´ë¯¸ì§€ì™€ í…ìŠ¤íŠ¸ ê°„ê²© ì¡°ì ˆ */
            background-image: url("/static/img/ë‹ë³´ê¸°.png");
            background-repeat: no-repeat;
            background-position: left;
            font-size: 16px;
            border:1px solid #d2d2d2;
            border-radius: 16px;
        }

        .button-wrap button {
            border:0px white;
        }
    </style>
</head>
{% endblock %}



{% block content %}
<body>
    <div class="form-container">
        <div class="select-wrap">
            <select name="search_option">
                <option value="title">ì œëª©</option>
                <option value="artist">ê°€ìˆ˜</option>
            </select>
        </div>
        <div class="input-wrap">
            <input type="text" name="query" id="search-query" placeholder="ë¶€ë¥´ê³  ì‹¶ì€ ê³¡ì„ ì…ë ¥í•˜ì„¸ìš”!ğŸ¤">
        </div>
        <div class="button-wrap">
            <button id="search-button"></button>
        </div>
    </div>

    <h1>
        {% for users in user %}
            {{users.nickname}}ë‹˜ì´ ë¶€ë¥´ë©´ ì¢‹ì„ ê²ƒ ê°™ì•„ìš”!
        {% endfor %}
    </h1>
    
    <table>
        <thead>
            <tr>
                <th>ê³¡ëª…</th>
                <th>ì•„í‹°ìŠ¤íŠ¸</th>
                <th>TJê³¡ë²ˆí˜¸</th>
                <th>KYê³¡ë²ˆí˜¸</th>
                <th>Mylist</th>
            </tr>
        </thead>
        <tbody>
            {% for song in songs %}
            <tr>
                <td>{{ song.title }}</td>
                <td>{{ song.artist }}</td>
                <td>{{ song.tj_song_num_id }}</td>
                <td>{{ song.ky_song_num_id }}</td>
                <td>
                    <select style="width: auto;" id="folderSelect">
                        {% for folder in folders %}
                            <option value="{{ folder.list_number }}">{{ folder.list_name }}</option>
                        {% endfor %}
                    </select>
                    <button onclick="addToDatabase('{{ song.ky_song_num_id }}', '{{ song.tj_song_num_id }}', '{{ song.title }}', '{{ song.artist }}', '{{ song.cmp }}', '{{ song.writer }}')">ì¶”ê°€</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</body>
</html>
{% endblock %}


{% block script %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
    $.ajaxSetup({
        headers: { "X-CSRFToken": '{{csrf_token}}' }
    });
</script>

<script>
    function addToDatabase(kySongNum, tjSongNum, title, artist, cmp, writer) {
        // ì„ íƒí•œ My_folderì˜ list_numberì™€ list_name ê°€ì ¸ì˜¤ê¸°
        var folderSelect = $("#folderSelect");
        var listNumber = folderSelect.val();
        var listName = folderSelect.find("option:selected").text();

        // AJAX ìš”ì²­ì„ ìƒì„±
        $.ajax({
            type: 'POST',
            url: '/song-list/add-to-database/',
            dataType: 'text',
            headers: {
                "X-CSRFToken": csrftoken
            },
            contentType: 'application/json',
            data: JSON.stringify({
                kySongNum: kySongNum,
                tjSongNum: tjSongNum,
                title: title,
                artist: artist,
                cmp: cmp,
                writer: writer,
                listNumber: listNumber,
                listName: listName
            }),
            success: function(response) {
                var parsedResponse = JSON.parse(response);
                if (parsedResponse.status === 'success') {
                    console.log('ë°ì´í„° ì¶”ê°€ ì„±ê³µ');
                    var successMessage = 'ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    alert(successMessage)
                } else if (parsedResponse.status === 'error') {
                    console.log('ë°ì´í„° ì¶”ê°€ ì‹¤íŒ¨: ' + parsedResponse.message);
                    var errorMessage = 'ì´ë¯¸ ì¶”ê°€ëœ ë…¸ë˜ì…ë‹ˆë‹¤.';
                    alert(errorMessage);
                }
            },
            error: function(xhr, textStatus, errorThrown) {
                console.log('AJAX ìš”ì²­ ì‹¤íŒ¨');
                var errorMessage = 'error';
                alert(errorMessage);
            }
        });

        console.log(data);
    }

    function handleEnterKeyPress(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            $('#search-button').click(); // "ë¡œê·¸ì¸" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ
        }
    }

    $(document).ready(function () {
        $('#search-query').keypress(handleEnterKeyPress);
        
        $("#search-button").click(function (event) {
            event.preventDefault();

            var query = $("input[name='query']").val();
            var category = $('select[name=search_option]').val();
            var url = '/song-list/search/?category=' + encodeURIComponent(category) + '&query=' + encodeURIComponent(query); // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¥¼ í¬í•¨í•œ URL ìƒì„±

            console.log(url);

            $.ajax({
                type: 'GET',
                url: url,  // ìƒì„±í•œ URL ì‚¬ìš©
                success: function (response) {
                    // í•„í„°ë§ëœ ë…¸ë˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°›ì•„ì™€ì„œ í™”ë©´ì— í‘œì‹œí•˜ëŠ” ë¡œì§ ì‘ì„±
                    window.location.href = url;
                    console.log(response);
                },
            });
        });
    });

    


    document.addEventListener("DOMContentLoaded", function() {
        var urlParams = new URLSearchParams(window.location.search);
        var category = urlParams.get('category');
        var query = urlParams.get('query');
        
        if (category) {
            $('select[name=search_option]').val(category);
        }

        if (query) {
            $("input[name='query']").val(decodeURIComponent(query));
        }
    });


</script>
{% endblock %}

