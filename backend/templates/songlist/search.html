{% extends 'navbar.html' %}
{% block style %}
<link rel="stylesheet" href="/static/css/search-html.css">
<style>
    .main_body {
        display: flex;
        justify-content: center;
        padding-top: 5px;
        padding-left: 150px;
        background-color: #f7f7f7;
    }

    table {
        border-collapse: collapse;
        width: 100%;
    }

    th, td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    select {
        width:50%;
        height:30px;
        font: 300 12px "Inter",sans-serif;
        color: #b0b0b1;
        border-radius: 16px;
        border: 0px #f7f7f7;
        appearance:none; 
        background:transparent; 
    }

    select::-ms-expand{
        display:none;/*for IE10,11*/
    }

    .select-wrap {
        width:70px;
        height: 30px;
        padding-left: 28px;
        /* border:1px solid #d2d2d2; */
        border-radius: 16px;
        background:url('/static/img/ìŠ¤í¬ë¦°ìƒ·\ 2023-07-19\ 031302.png') no-repeat 90% 50%/15px auto;
    }

    .form-container {
        display: flex;
        justify-content: center; /* ê°€ìš´ë° ì •ë ¬ */
    }

    .form-container div {
        margin-right: 10px; /* ê° ìš”ì†Œ ì‚¬ì´ì˜ ê°„ê²© ì¡°ì ˆ */
    }

    /* input íƒœê·¸ ìŠ¤íƒ€ì¼ë§ - ì´ë¯¸ì§€ ì¶”ê°€ */
    .input-wrap input {
        width: 300px;
        height: 30px;
        padding-left: 30px; /* ì´ë¯¸ì§€ì™€ í…ìŠ¤íŠ¸ ê°„ê²© ì¡°ì ˆ */
        background-image: url("/static/img/ë‹ë³´ê¸°.png");
        background-repeat: no-repeat;
        background-position: left;
        font-size: 16px;
        border:1px solid #d2d2d2;
        border-radius: 16px;
    }

    .button-wrap button {
        border:0px white;
    }

    .modal {
        width: 100%;
        height: 100%;
        position: absolute;
        left: 0;
        top: 0;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(1.5px);
        -webkit-backdrop-filter: blur(1.5px);
    }

    .modal_window {
        background: white;
        backdrop-filter: blur(13.5px);
        -webkit-backdrop-filter: blur(13.5px);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        width: 530px;
        height: 400px;
        position: relative;
    }

    .modal_title{
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        font-weight: bold;
        font-size: 20px;
        border-bottom: 0px solid rgba(0, 0, 0, 0.18);
        margin: 10px;
    }

    .modal_title_side{
        margin: 5px;
        flex: 0 0 40px;
        text-align: center;
        font-size: 20px;
    }

    .modal-mylist{
        display: flex;
        flex-direction: column;
        border-left: 1px solid rgba(0, 0, 0, 0.18);;
    }

    li, ol, ul{
        list-style: none;
    }

    .popup_list-thumbnail, .popup_list{
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center;
    }

    .popup_list{
        -webkit-box-pack: justify;
        -ms-flex-pack: justify;
        justify-content: space-between;
        margin-bottom: 14px;
        cursor: pointer;
    }
        
    .popup_list-thumbnail{
        -webkit-box-pack: center;
        -ms-flex-pack: center;
        justify-content: center;
        width: 70px;
        height: 70px;
        margin-left: 12px;
        overflow: hidden;
        background: #f0f0f0;
        border-radius: 4px;
    }

    .popup_list-text{
        -webkit-box-flex: 1;
        -ms-flex-positive: 1;
        flex-grow: 1;
        width: 10px;
        margin-left: 22px;
    }

    .popup_list-title{
        margin-bottom: 4px;
        font-size: 16px;
        font-weight: 400;
        line-height: 22px;
        color: #181818;
    }

    .popup_list-count{
        font-size: 12px;
        font-weight: 400;
        line-height: 14px;
        color: #989898;
    }
</style>
{% endblock %}



{% block content %}

<div class="search-html">
    <div class="search-html-top"></div>

    <div class="main-frame">
        <div class="frame-2006">
            <div class="main-frame-search-text">
                <div class="arrwos-box">
                    <img class="arrwos-box-style" src="/static/img/vector2.svg">
                </div>

                <div class="main-frame-search-text-style"> ë¶€ë¥¼ ê³¡ ê²€ìƒ‰</div>

                <div class="arrwos-box">
                    <img class="arrwos-box-style" src="/static/img/interface-essential-dots.svg">
                </div>          
            </div>

            <div class="frame-985">
                <div class="searchbar-2">
                    <img src="/static/img/select.svg">
                    <select name="search_option">
                        <option value="title">ì œëª©</option>
                        <option value="artist">ê°€ìˆ˜</option>
                    </select>
                </div>
                <div class="searchbar-1">
                    <!-- <div class="searchbar-style"></div> -->
                    <div class="icon-search-normal-1">
                        <img src="/static/img/search.svg">
                    </div>
                    <div class="searchbar-text">ë¶€ë¥´ê³  ì‹¶ì€ ê³¡ì„ ê²€ìƒ‰í•˜ì„¸ìš”!</div>
                </div>
            </div>
        </div>

        <div class="song-box">
            <div class="song-box-head">
                <div style="width: 80px;">ê³¡ëª…/ì•„í‹°ìŠ¤íŠ¸</div>
                <div style="width: 53px">TJê³¡ë²ˆí˜¸</div>
                <div style="width: 53px;">KYê³¡ë²ˆí˜¸</div>
                <div style="width: 24px;">ë‹´ê¸°</div>
            </div>
            <div class="song-box-body">
                {% for result in results %}
                <div class="song-list">
                    <div class="title-text">
                        <div class="title-text">result.title</div>
                        <div class="artist-text">result.artist</div>
                    </div>
                    <div class="tj">result.tj</div>
                    <div class="ky">result.ky</div>
                    <div class="ellipse-12">
                        <img style="width: 18px; height: 18px;" src="/static/img/icon-add.svg">
                    </div>
 
                </div>
                {% endfor %}
            </div>
        </div>


    </div>
</div>





<div class="form-container">
    <div class="select-wrap">
        <select name="search_option">
            <option value="title">ì œëª©</option>
            <option value="artist">ê°€ìˆ˜</option>
        </select>
    </div>
    <div class="input-wrap">
        <input type="text" name="query" id="search-query" placeholder="ë¶€ë¥´ê³  ì‹¶ì€ ê³¡ì„ ì…ë ¥í•˜ì„¸ìš”!ğŸ¤">
    </div>
    <div class="button-wrap">
        <button id="search-button"></button>
    </div>
</div>

<table>
    <thead>
        <tr>
            <th>KYê³¡ë²ˆí˜¸</th>
            <th>TJê³¡ë²ˆí˜¸</th>
            <th>ê³¡ëª…</th>
            <th>ì•„í‹°ìŠ¤íŠ¸</th>
            <th>Mylist</th>
        </tr>
    </thead>
    <tbody>
        {% for result in results %}
        <tr>
            <td>{{ result.ky }}</td>
            <td>{{ result.tj }}</td>
            <td>{{ result.title }}</td>
            <td>{{ result.artist }}</td>
            <td>
                <select style="width: auto;" id="folderSelect">
                    {% for folder in folders %}
                        <option value="{{ folder.list_number }}">{{ folder.list_name }}</option>
                    {% endfor %}
                </select>
                <button onclick="addToDatabase('{{ result.ky }}', '{{ result.tj }}', '{{ result.title }}', '{{ result.artist }}', '{{ result.cmp }}', '{{ result.writer }}')">ì¶”ê°€</button>
                <button id="button_add_list">test</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>



<!-- ë¦¬ìŠ¤íŠ¸ì— ë…¸ë˜ ì¶”ê°€í•˜ëŠ” ëª¨ë‹¬ -->
<div id="modal-add-song" class="modal modal-overlay-song">
    <div class="modal_window">
        <div class="modal_title">ë‚´ ë¦¬ìŠ¤íŠ¸ì— ë‹´ê¸°
            <div class="modal-title-side"></div>
            <div class="modal-title-side">
                <span id="close_modal" class="close_modal material-icons-outlined">
                    X
                </span>
            </div>
        </div>
        <div class="modal-mylist">
            {% for folder in folders %}
            <li>
                <div class="popup_list">
                    <div class="popup_list-thumbnail">
                        <img src="/static/img/music.svg">
                    </div>
                    <div class="popup_list-text">
                        <p class="popup_list-title"> {{folder.list_name}} </p>
                        <p class="popup_list-count"> {{folder.song_count}} </p>
                    </div>
                </div> 
            </li>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}


{% block script %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
    $.ajaxSetup({
        headers: { "X-CSRFToken": '{{csrf_token}}' }
    });
</script>

<script>
    function selectOption() {
        const selectElement = document.querySelector('.searchbar-2 select');
        selectElement.focus(); // ì´ ë¶€ë¶„ì€ ì„ íƒ ìƒíƒœë¥¼ ì‹œê°ì ìœ¼ë¡œ í‘œì‹œí•˜ê¸° ìœ„í•´ í¬ì»¤ìŠ¤ë¥¼ ì¤ë‹ˆë‹¤.
        selectElement.click(); // select ìš”ì†Œë¥¼ í´ë¦­í•˜ì—¬ ë“œë¡­ë‹¤ìš´ ëª©ë¡ì„ ì—½ë‹ˆë‹¤.
    }

    function addToDatabase(kySongNum, tjSongNum, title, artist, cmp, writer) {
        // ì„ íƒí•œ My_folderì˜ list_numberì™€ list_name ê°€ì ¸ì˜¤ê¸°
        var folderSelect = $("#folderSelect");
        var listNumber = folderSelect.val();
        var listName = folderSelect.find("option:selected").text();

        // AJAX ìš”ì²­ì„ ìƒì„±
        $.ajax({
            type: 'POST',
            url: '/song-list/add-to-database/',
            dataType: 'text',
            headers: {
                "X-CSRFToken": csrftoken
            },
            contentType: 'application/json',
            data: JSON.stringify({
                kySongNum: kySongNum,
                tjSongNum: tjSongNum,
                title: title,
                artist: artist,
                cmp: cmp,
                writer: writer,
                listNumber: listNumber,
                listName: listName
            }),
            success: function(response) {
                var parsedResponse = JSON.parse(response);
                if (parsedResponse.status === 'success') {
                    console.log('ë°ì´í„° ì¶”ê°€ ì„±ê³µ');
                    var successMessage = 'ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    alert(successMessage)
                } else if (parsedResponse.status === 'error') {
                    console.log('ë°ì´í„° ì¶”ê°€ ì‹¤íŒ¨: ' + parsedResponse.message);
                    var errorMessage = 'ì´ë¯¸ ì¶”ê°€ëœ ë…¸ë˜ì…ë‹ˆë‹¤.';
                    alert(errorMessage);
                }
            },
            error: function(xhr, textStatus, errorThrown) {
                console.log('AJAX ìš”ì²­ ì‹¤íŒ¨');
                var errorMessage = 'error';
                alert(errorMessage);
            }
        });

        console.log(data);
    }

    function handleEnterKeyPress(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            $('#search-button').click(); // "ë¡œê·¸ì¸" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ
        }
    }

    $(document).ready(function () {
        $('#search-query').keypress(handleEnterKeyPress);
        
        $("#search-button").click(function (event) {
            event.preventDefault();

            var query = $("input[name='query']").val();
            var category = $('select[name=search_option]').val();
            var url = '/song-list/search/?category=' + encodeURIComponent(category) + '&query=' + encodeURIComponent(query); // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¥¼ í¬í•¨í•œ URL ìƒì„±

            console.log(url);

            $.ajax({
                type: 'GET',
                url: url,  // ìƒì„±í•œ URL ì‚¬ìš©
                success: function (response) {
                    // í•„í„°ë§ëœ ë…¸ë˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°›ì•„ì™€ì„œ í™”ë©´ì— í‘œì‹œí•˜ëŠ” ë¡œì§ ì‘ì„±
                    window.location.href = url;
                    console.log(response);
                },
            });
        });
    });

    


    document.addEventListener("DOMContentLoaded", function() {
        var urlParams = new URLSearchParams(window.location.search);
        var category = urlParams.get('category');
        var query = urlParams.get('query');
        
        if (category) {
            $('select[name=search_option]').val(category);
        }

        if (query) {
            $("input[name='query']").val(decodeURIComponent(query));
        }
    });

    //ëª¨ë‹¬ ë„ìš°ê¸° ì½”ë“œ
    const modal = document.getElementById("modal-add-song");
    const buttonAddFeed = document.getElementById("button_add_list");
    buttonAddFeed.addEventListener("click", e=> {
        modal.style.top = window.pageYOffset + 'px'; // topì„ ì´ìš©í•´ ì‹œì‘ y ìœ„ì¹˜ë¥¼ ë°”ê¿”ì¤Œ
        modal.style.display = "flex";
        document.body.style.overflowY = "hidden"; //ìŠ¤í¬ë¡¤ ì—†ì• ê¸°

        console.log(window.pageYOffset + " ìœ„ì¹˜"); //ë¡œê·¸ ì°ê¸°
    });

    //ëª¨ë‹¬ ë‹«ê¸° ì½”ë“œ
    const buttonCloseModal = 
    document.getElementById("close_modal");
    buttonCloseModal.addEventListener("click", e => {
        modal.style.display = "none";
        document.body.style.overflowY = "visible";
    });


</script>
{% endblock %}

