{% extends 'navbar.html' %}
{% block style %}
<link rel="stylesheet" href="/static/css/search-html-2.css">
<style>
</style>
{% endblock %}



{% block content %}

<div class="search-html">
    <div class="search-html-top"></div>

    <div class="main-frame">
        <div class="frame-2006">
            <div class="main-frame-search-text">
                <a href="/">
                    <div class="arrwos-box">
                        <img class="arrwos-box-style" src="/static/img/vector2.svg">
                    </div>
                </a>

                <div class="main-frame-search-text-style"> Î∂ÄÎ•º Í≥° Í≤ÄÏÉâ</div>

                <div class="arrwos-box">
                    <img class="arrwos-box-style" src="/static/img/interface-essential-dots.svg">
                </div>          
            </div>

            <div class="frame-985">
                <div class="searchbar-2">
                    <img src="/static/img/select.svg">
                    <select name="search_option">
                        <option value="title">Ï†úÎ™©</option>
                        <option value="artist">Í∞ÄÏàò</option>
                    </select>
                </div>
                <div class="searchbar-1">
                    <!-- <div class="searchbar-style"></div> -->
                    <div class="icon-search-normal-1" id="search-button">
                        <img src="/static/img/search.svg">
                    </div>
                    <input class="searchbar-text" type="text" name="query" id="search-query" placeholder="Î∂ÄÎ•¥Í≥† Ïã∂ÏùÄ Í≥°ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!üé§">
                    <div class="searchbar-button">
                        <button class="searchbar-button" id="search-button"></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="song-box">
            <div class="song-box-head">
                <div style="width: 80px;">Í≥°Î™Ö/ÏïÑÌã∞Ïä§Ìä∏</div>
                <div style="width: 53px">TJÍ≥°Î≤àÌò∏</div>
                <div style="width: 53px;">KYÍ≥°Î≤àÌò∏</div>
                <div style="width: 24px;">Îã¥Í∏∞</div>
            </div>
            <div class="song-box-body">
                {% for result in results %}
                <div class="song-list">
                    <div class="title-artist-box">
                        <div class="title-text">{{result.title}}</div>
                        <div class="artist-text">{{result.artist}}</div>
                    </div>
                    <div class="tj">{{result.tj}}</div>
                    <div class="ky">{{result.ky}}</div>
                    <div class="ellipse-12">
                        <button class="ellipse-12 button-add-list" id="button_add_list"
                                data-ky="{{ result.ky }}"
                                data-tj="{{ result.tj }}"
                                data-title="{{ result.title }}"
                                data-artist="{{ result.artist }}"
                                data-cmp="{{ result.cmp }}"
                                data-writer="{{ result.writer }}"
                                data-master="{{ result.master_number }}">
                            <img style="width: 18px; height: 18px;" src="/static/img/icon-add.svg">
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>


<!-- Î¶¨Ïä§Ìä∏Ïóê ÎÖ∏Îûò Ï∂îÍ∞ÄÌïòÎäî Î™®Îã¨ -->
<div id="modal-add-song" class="modal modal-overlay-song">
    <div class="modal_window">
        <div class="modal_title">ÎÇ¥ Î¶¨Ïä§Ìä∏Ïóê Îã¥Í∏∞
            <div class="modal-title-side"></div>
            <div class="modal-title-side">
                <span id="close_modal" class="close_modal material-icons-outlined" style="font-size: large;">
                    X
                </span>
            </div>
        </div>
        <div class="modal-mylist">
            {% for folder in folders %}
            <li>
                <div class="popup_list" id="folderSelect" data-list-number="{{folder.list_number}}">
                    <div class="popup_list-thumbnail">
                        <img src="/static/img/music.svg">
                    </div>
                    <div class="popup_list-text">
                        <p class="popup_list-title list-name"> {{folder.list_name}} </p>
                        <p class="popup_list-count"> {{folder.song_count}} </p>
                    </div>
                </div>
            </li>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}


{% block script %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
    $.ajaxSetup({
        headers: { "X-CSRFToken": '{{csrf_token}}' }
    });
</script>

<script>
    function selectOption() {
        const selectElement = document.querySelector('.searchbar-2 select');
        selectElement.focus(); // Ïù¥ Î∂ÄÎ∂ÑÏùÄ ÏÑ†ÌÉù ÏÉÅÌÉúÎ•º ÏãúÍ∞ÅÏ†ÅÏúºÎ°ú ÌëúÏãúÌïòÍ∏∞ ÏúÑÌï¥ Ìè¨Ïª§Ïä§Î•º Ï§çÎãàÎã§.
        selectElement.click(); // select ÏöîÏÜåÎ•º ÌÅ¥Î¶≠ÌïòÏó¨ ÎìúÎ°≠Îã§Ïö¥ Î™©Î°ùÏùÑ ÏóΩÎãàÎã§.
    }

    
    var selectedSongData = {};

    document.querySelector('body').addEventListener('click', (e) => {
        // Check if the clicked element has the 'button-add-list' class
        if (e.target.closest('.button-add-list')) {
            var button = e.target.closest('.button-add-list');
            // Assign song data on selectedSongData
            selectedSongData = {
                master: button.getAttribute('data-master'),
                kySongNum: button.getAttribute('data-ky'),
                tjSongNum: button.getAttribute('data-tj'),
                title: button.getAttribute('data-title'),
                artist: button.getAttribute('data-artist'),
                cmp: button.getAttribute('data-cmp'),
                writer: button.getAttribute('data-writer')
            };
        }
    });

    document.querySelector('body').addEventListener('click', (e) => {
        // Check if the clicked element has the 'popup_list' class
        if (e.target.closest('.popup_list')) {
            var folderElement = e.target.closest('.popup_list');
            var listNumber = folderElement.getAttribute('data-list-number');
            var listName = folderElement.querySelector('.list-name').textContent.trim();

            console.log(selectedSongData)

            // Merge the song and folder data into one object
            var sendData = Object.assign({}, selectedSongData, { listNumber, listName });

            $.ajax({
                type: 'POST',
                url: '/song-list/add-to-database/',
                dataType: 'text',
                headers: {
                    "X-CSRFToken": csrftoken
                },
                contentType: 'application/json',
                data: JSON.stringify(sendData),
                success: function(response) {
                    var parsedResponse = JSON.parse(response);
                    if (parsedResponse.status === 'success') {
                        console.log('Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä ÏÑ±Í≥µ');
                        location.reload();
                        var successMessage = 'Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.';
                        alert(successMessage)
                    } else if (parsedResponse.status === 'error') {
                        console.log('Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä Ïã§Ìå®: ' + parsedResponse.message);
                        var errorMessage = 'Ïù¥ÎØ∏ Ï∂îÍ∞ÄÎêú ÎÖ∏ÎûòÏûÖÎãàÎã§.';
                        alert(errorMessage);
                    }
                },
                error: function(xhr, textStatus, errorThrown) {
                    console.log('AJAX ÏöîÏ≤≠ Ïã§Ìå®');
                    var errorMessage = 'error';
                    alert(errorMessage);
                }
            });

            console.log(sendData);
        }
    });


    function handleEnterKeyPress(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            $('#search-button').click();
        }
    }

    $(document).ready(function () {
        $('#search-query').keypress(handleEnterKeyPress);
        
        $("#search-button").click(function (event) {
            event.preventDefault();

            var query = $("input[name='query']").val();
            var category = $('select[name=search_option]').val();
            var url = '/song-list/search/?category=' + encodeURIComponent(category) + '&query=' + encodeURIComponent(query); // ÏøºÎ¶¨ ÌååÎùºÎØ∏ÌÑ∞Î•º Ìè¨Ìï®Ìïú URL ÏÉùÏÑ±

            console.log(url);

            $.ajax({
                type: 'GET',
                url: url,  // ÏÉùÏÑ±Ìïú URL ÏÇ¨Ïö©
                success: function (response) {
                    // ÌïÑÌÑ∞ÎßÅÎêú ÎÖ∏Îûò Î¶¨Ïä§Ìä∏Î•º Î∞õÏïÑÏôÄÏÑú ÌôîÎ©¥Ïóê ÌëúÏãúÌïòÎäî Î°úÏßÅ ÏûëÏÑ±
                    window.location.href = url;
                    console.log(response);
                },
            });
        });
    });

    


    document.addEventListener("DOMContentLoaded", function() {
        var urlParams = new URLSearchParams(window.location.search);
        var category = urlParams.get('category');
        var query = urlParams.get('query');
        
        if (category) {
            $('select[name=search_option]').val(category);
        }

        if (query) {
            $("input[name='query']").val(decodeURIComponent(query));
        }
    });

    //Î™®Îã¨ ÎùÑÏö∞Í∏∞ ÏΩîÎìú
    const modal = document.getElementById("modal-add-song");
    const buttonsAddList = document.querySelectorAll(".ellipse-12");

    buttonsAddList.forEach(button => {
        button.addEventListener("click", e => {
            modal.style.top = window.pageYOffset + 'px'; // Î™®Îã¨ Ï∞ΩÏù¥ Ïä§ÌÅ¨Î°§Ïóê Îî∞Îùº ÏõÄÏßÅÏù¥ÎèÑÎ°ù ÏúÑÏπò ÏÑ§Ï†ï
            modal.style.display = "flex";
            document.body.style.overflowY = "hidden"; // Ïä§ÌÅ¨Î°§ ÏóÜÏï†Í∏∞

            console.log(window.pageYOffset + " ÏúÑÏπò"); // ÏúÑÏπò Î°úÍ∑∏ Ï∞çÍ∏∞
        });
    });


    //Î™®Îã¨ Îã´Í∏∞ ÏΩîÎìú
    const buttonCloseModal = 
    document.getElementById("close_modal");
    buttonCloseModal.addEventListener("click", e => {
        modal.style.display = "none";
        document.body.style.overflowY = "visible";
    });


</script>
{% endblock %}

